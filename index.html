<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hip Hop Visual Studio - Wide Hollows</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* ... your original CSS unchanged ... */
        /* [Keep your existing CSS here for brevity] */
    </style>
</head>
<body>
    <!-- Password Protection -->
    <div id="passwordOverlay" class="password-overlay" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
        <form class="password-form" id="passwordForm" autocomplete="off">
            <h1 id="passwordTitle">üîê ACCESS CONTROL</h1>
            <p>Enter password to continue</p>
            <input 
                type="password" 
                id="passwordInput" 
                class="password-input" 
                placeholder="Password" 
                autocomplete="off" 
                required 
                aria-label="Password"
            >
            <button type="submit" class="password-btn">UNLOCK</button>
            <div id="passwordError" class="password-error" aria-live="polite"></div>
        </form>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app" aria-hidden="true">
        <div class="container">
            <div class="header">
                <h1>üéß HIP HOP VISUAL STUDIO</h1>
                <p>POWERED BY LUMA AI ‚Ä¢ WIDE HOLLOWS EDITION</p>
            </div>

            <div class="card-grid">
                <div class="card prompt-panel">
                    <div class="form-group">
                        <label for="prompt">üé§ DESCRIBE YOUR HIP HOP VISUAL:</label>
                        <textarea id="prompt" class="input-field prompt-input" 
                                  placeholder="Vinyl records spinning with golden light rays in a smoky NYC basement..." rows="5" required aria-label="Describe your hip hop visual"></textarea>
                    </div>
                    
                    <button id="generateBtn" class="button generate-btn">üéµ GENERATE HIP HOP VISUAL</button>

                    <div class="form-group">
                        <label>üìÄ CLASSIC VIBES:</label>
                        <div class="preset-grid">
                            <button type="button" class="preset-btn" data-prompt="You are a professional hip hop videographer. Create a dynamic 3D scene of vintage turntables spinning vinyl records with golden light rays cutting through smoke.">Vintage Turntables</button>
                            <button type="button" class="preset-btn" data-prompt="You are a retro music video director. Generate a nostalgic scene featuring a classic boombox with cassette tapes floating around it against a brick wall.">Classic Boombox</button>
                            <button type="button" class="preset-btn" data-prompt="You are an urban art cinematographer. Create a living graffiti wall scene where colorful paint is dripping and swirling in 3D motion.">Graffiti Wall</button>
                            <button type="button" class="preset-btn" data-prompt="You are a concert stage designer. Generate a golden microphone on stage with dramatic spotlight beams cutting through smoke and crowd silhouettes.">Golden Microphone</button>
                            <button type="button" class="preset-btn" data-prompt="You are a surreal hip hop visual artist. Create a stack of vintage vinyl records morphing and transforming into a city skyline with neon lights.">Vinyl City Skyline</button>
                            <button type="button" class="preset-btn" data-prompt="You are a retro-futuristic video creator. Generate a VHS tape unraveling with the tape transforming into musical notes floating through the air.">VHS Transformation</button>
                        </div>
                    </div>
                    
                    <div id="error" class="error" aria-live="assertive">
                        <p id="errorMessage"></p>
                    </div>
                </div>

                <div class="card visual-panel">
                    <div id="status" class="status" aria-live="polite">
                        <div class="spinner" aria-hidden="true"></div>
                        <h3>COOKING UP THE BEAT...</h3>
                        <p id="statusText">Dropping those fresh visuals...</p>
                    </div>

                    <div id="result" class="result">
                        <video id="videoPlayer" controls aria-label="Generated Hip Hop Visual">
                            Your browser does not support video playback.
                        </video>
                        <div class="success">
                            <h3>üî• VISUAL DROPPED!</h3>
                            <p id="promptDisplay"></p>
                        </div>
                    </div>

                    <div id="placeholder" class="placeholder">
                        <div class="placeholder-icon" aria-hidden="true">üéµ</div>
                        <h3>YOUR HIP HOP VISUAL WILL DROP HERE</h3>
                        <p>Describe your vibe and let's create some fire!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Password Protection
    const CORRECT_PASSWORD = "widehollows2024";

    // Autofocus and focus trap for accessibility
    window.addEventListener('DOMContentLoaded', () => {
        const passwordInput = document.getElementById('passwordInput');
        passwordInput.focus();

        // Trap focus in password modal when active
        document.addEventListener('focus', function(event) {
            const overlay = document.getElementById('passwordOverlay');
            if (overlay.style.display !== 'none' && !overlay.contains(event.target)) {
                event.stopPropagation();
                passwordInput.focus();
            }
        }, true);
    });

    // Hide error message on input
    document.getElementById('passwordInput').addEventListener('input', () => {
        document.getElementById('passwordError').textContent = '';
    });

    // Submit handler for password form
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        checkPassword();
    });

    function checkPassword() {
        const input = document.getElementById('passwordInput');
        const error = document.getElementById('passwordError');
        const overlay = document.getElementById('passwordOverlay');
        const mainApp = document.getElementById('mainApp');

        if (input.value === CORRECT_PASSWORD) {
            overlay.style.display = 'none';
            mainApp.classList.add('unlocked');
            mainApp.setAttribute('aria-hidden', 'false');
            localStorage.setItem('lumaAccess', 'granted');
        } else {
            error.textContent = 'Incorrect password. Try again.';
            input.value = '';
            input.focus();
        }
    }

    // Check if already unlocked
    if (localStorage.getItem('lumaAccess') === 'granted') {
        document.getElementById('passwordOverlay').style.display = 'none';
        document.getElementById('mainApp').classList.add('unlocked');
        document.getElementById('mainApp').setAttribute('aria-hidden', 'false');
    }

    // Main App Logic
    let isGenerating = false;

    function showError(message) {
        const errorDiv = document.getElementById('error');
        document.getElementById('errorMessage').textContent = message;
        errorDiv.classList.add('active');
        setTimeout(() => {
            errorDiv.classList.remove('active');
        }, 8000);
    }

    function hideAll() {
        document.getElementById('status').classList.remove('active');
        document.getElementById('result').classList.remove('active');
        document.getElementById('error').classList.remove('active');
        document.getElementById('placeholder').style.display = 'none';
    }

    async function generateVideo() {
        if (isGenerating) return;

        const prompt = document.getElementById('prompt').value.trim();
        if (!prompt) {
            showError('Please enter a prompt');
            return;
        }

        isGenerating = true;
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = 'üéµ COOKING UP VISUALS...';

        hideAll();
        document.getElementById('status').classList.add('active');
        document.getElementById('statusText').textContent = 'LAYING DOWN THE FOUNDATION...';

        try {
            // Create generation
            const createResponse = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!createResponse.ok) {
                let errorMsg = 'Failed to start generation';
                try {
                    const error = await createResponse.json();
                    errorMsg = error.error || errorMsg;
                } catch {}
                throw new Error(errorMsg);
            }

            const { id } = await createResponse.json();
            document.getElementById('statusText').textContent = `BEAT IS COOKING (ID: ${id.slice(0,8).toUpperCase()}...)`;

            // Poll for completion
            let attempts = 0;
            const maxAttempts = 72; // 6 minutes

            const pollInterval = setInterval(async () => {
                attempts++;
                document.getElementById('statusText').textContent = 
                    `MIXING THE VISUALS... (${attempts}/${maxAttempts}) - DROPS IN 2-5 MINUTES`;

                try {
                    const statusResponse = await fetch(`/api/status?id=${encodeURIComponent(id)}`);
                    if (statusResponse.ok) {
                        const data = await statusResponse.json();
                        if (data.state === 'completed') {
                            clearInterval(pollInterval);
                            hideAll();
                            document.getElementById('videoPlayer').src = data.assets.video;
                            document.getElementById('promptDisplay').textContent = `"${prompt}"`;
                            document.getElementById('result').classList.add('active');
                            document.getElementById('videoPlayer').focus();
                        } else if (data.state === 'failed') {
                            clearInterval(pollInterval);
                            throw new Error(`Generation failed: ${data.failure_reason || 'Unknown error'}`);
                        }
                    }
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        throw new Error('Generation timed out');
                    }
                } catch (pollError) {
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showError(pollError.message || 'Error during polling');
                        hideAll();
                        document.getElementById('placeholder').style.display = 'block';
                        isGenerating = false;
                        btn.disabled = false;
                        btn.textContent = 'üéµ GENERATE HIP HOP VISUAL';
                    }
                }
            }, 5000);

        } catch (error) {
            hideAll();
            showError(error.message);
            document.getElementById('placeholder').style.display = 'block';
        } finally {
            isGenerating = false;
            btn.disabled = false;
            btn.textContent = 'üéµ GENERATE HIP HOP VISUAL';
        }
    }

    // Event listeners
    document.getElementById('generateBtn').addEventListener('click', generateVideo);

    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('prompt').value = btn.getAttribute('data-prompt');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                btn.style.transform = '';
            }, 150);
            document.getElementById('prompt').focus();
        });
    });

    document.getElementById('prompt').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            generateVideo();
        }
    });

    // Initialize
    document.getElementById('placeholder').style.display = 'block';
    </script>
</body>
</html>
